<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - FlaskAPI Bookstore</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Custom CSS -->
    <link rel="stylesheet" href="assets/css/style.css">
    
    <style>
        .stat-card {
            border-left: 4px solid;
            transition: transform 0.2s;
        }
        .stat-card:hover {
            transform: translateY(-5px);
        }
        .stat-card.books { border-left-color: #007bff; }
        .stat-card.orders { border-left-color: #28a745; }
        .stat-card.users { border-left-color: #ffc107; }
        .stat-card.revenue { border-left-color: #dc3545; }
        .order-status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.875rem;
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="index.html">
                <i class="fas fa-book"></i> FlaskAPI Bookstore
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="index.html">
                            <i class="fas fa-home"></i> Home
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="admin.html">
                            <i class="fas fa-cog"></i> Admin
                        </a>
                    </li>
                    <li class="nav-item" id="user-menu">
                        <!-- Populated by auth.js -->
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container mt-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1><i class="fas fa-tachometer-alt"></i> Admin Dashboard</h1>
            <button class="btn btn-primary" onclick="refreshDashboard()">
                <i class="fas fa-sync-alt"></i> Refresh
            </button>
        </div>

        <!-- Statistics Cards -->
        <div class="row mb-4" id="statsContainer">
            <div class="col-md-3 mb-3">
                <div class="card stat-card books">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="text-muted">Total Books</h6>
                                <h2 id="totalBooks">0</h2>
                            </div>
                            <i class="fas fa-book fa-3x text-primary"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card stat-card orders">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="text-muted">Total Orders</h6>
                                <h2 id="totalOrders">0</h2>
                            </div>
                            <i class="fas fa-shopping-cart fa-3x text-success"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card stat-card users">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="text-muted">Total Users</h6>
                                <h2 id="totalUsers">-</h2>
                            </div>
                            <i class="fas fa-users fa-3x text-warning"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card stat-card revenue">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="text-muted">Total Revenue</h6>
                                <h3 id="totalRevenue">PKR 0</h3>
                            </div>
                            <i class="fas fa-dollar-sign fa-3x text-danger"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabs -->
        <ul class="nav nav-tabs mb-4" id="adminTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="orders-tab" data-bs-toggle="tab" data-bs-target="#orders" type="button">
                    <i class="fas fa-box"></i> Orders Management
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="books-tab" data-bs-toggle="tab" data-bs-target="#books" type="button">
                    <i class="fas fa-book"></i> Books Management
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="authors-tab" data-bs-toggle="tab" data-bs-target="#authors" type="button">
                    <i class="fas fa-user-edit"></i> Authors Management
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="charts-tab" data-bs-toggle="tab" data-bs-target="#charts" type="button">
                    <i class="fas fa-chart-bar"></i> Analytics & Charts
                </button>
            </li>
        </ul>

        <!-- Tab Content -->
        <div class="tab-content" id="adminTabContent">
            <!-- Orders Tab -->
            <div class="tab-pane fade show active" id="orders" role="tabpanel">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-list"></i> All Orders</h5>
                    </div>
                    <div class="card-body">
                        <div id="ordersContainer">
                            <div class="text-center">
                                <div class="spinner-border" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Books Tab -->
            <div class="tab-pane fade" id="books" role="tabpanel">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5><i class="fas fa-list"></i> All Books</h5>
                        <button class="btn btn-sm btn-success" onclick="showAddBookModal()">
                            <i class="fas fa-plus"></i> Add Book
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="booksContainer">
                            <div class="text-center">
                                <div class="spinner-border" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Authors Tab -->
            <div class="tab-pane fade" id="authors" role="tabpanel">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5><i class="fas fa-list"></i> All Authors</h5>
                        <button class="btn btn-sm btn-success" onclick="showAddAuthorModal()">
                            <i class="fas fa-plus"></i> Add Author
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <input type="text" class="form-control" id="authorSearch" placeholder="Search authors..." onkeyup="filterAuthors()">
                        </div>
                        <div id="authorsContainer">
                            <div class="text-center">
                                <div class="spinner-border" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Analytics & Charts Tab -->
            <div class="tab-pane fade" id="charts" role="tabpanel">
                <div class="row">
                    <!-- Order Status Distribution -->
                    <div class="col-md-6 mb-4">
                        <div class="card">
                            <div class="card-header">
                                <h5><i class="fas fa-chart-pie"></i> Order Status Distribution</h5>
                            </div>
                            <div class="card-body">
                                <canvas id="orderStatusChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Revenue Trend -->
                    <div class="col-md-6 mb-4">
                        <div class="card">
                            <div class="card-header">
                                <h5><i class="fas fa-chart-line"></i> Revenue by Order Status</h5>
                            </div>
                            <div class="card-body">
                                <canvas id="revenueChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Books by Category -->
                    <div class="col-md-6 mb-4">
                        <div class="card">
                            <div class="card-header">
                                <h5><i class="fas fa-chart-bar"></i> Books by Category (Top 10)</h5>
                            </div>
                            <div class="card-body">
                                <canvas id="categoryChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Top Selling Books -->
                    <div class="col-md-6 mb-4">
                        <div class="card">
                            <div class="card-header">
                                <h5><i class="fas fa-trophy"></i> Top Selling Books</h5>
                            </div>
                            <div class="card-body">
                                <canvas id="topBooksChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Order Status Modal -->
    <div class="modal fade" id="orderStatusModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Update Order Status</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="currentOrderId">
                    <div class="mb-3">
                        <label class="form-label">Order Status</label>
                        <select class="form-select" id="orderStatus">
                            <option value="Pending">Pending</option>
                            <option value="Confirmed">Confirmed</option>
                            <option value="Shipped">Shipped</option>
                            <option value="Delivered">Delivered</option>
                            <option value="Cancelled">Cancelled</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="updateOrderStatus()">Update Status</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Book Modal -->
    <div class="modal fade" id="addBookModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add New Book</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addBookForm">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Title *</label>
                                <input type="text" class="form-control" id="bookTitle" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">ISBN</label>
                                <input type="text" class="form-control" id="bookIsbn">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Price (PKR) *</label>
                                <input type="number" class="form-control" id="bookPrice" step="0.01" min="0" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Stock Quantity *</label>
                                <input type="number" class="form-control" id="bookStock" min="0" value="0" required>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Author</label>
                                <select class="form-select" id="bookAuthor">
                                    <option value="">Select Author</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Category</label>
                                <select class="form-select" id="bookCategory">
                                    <option value="">Select Category</option>
                                </select>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Image URL</label>
                            <input type="url" class="form-control" id="bookImageUrl" placeholder="https://example.com/image.jpg">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Description</label>
                            <textarea class="form-control" id="bookDescription" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="addBook()">Add Book</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Author Modal -->
    <div class="modal fade" id="addAuthorModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add New Author</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addAuthorForm">
                        <div class="mb-3">
                            <label class="form-label">Author Name *</label>
                            <input type="text" class="form-control" id="authorName" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="addAuthor()">Add Author</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Custom JS -->
    <script src="assets/js/config.js"></script>
    <script src="assets/js/utils.js"></script>
    <script src="assets/js/auth.js"></script>
    <script src="assets/js/api.js"></script>
    
    <script>
        // Check admin access
        if (!isLoggedIn() || !isAdmin()) {
            showToast('Access denied. Admin only.', 'danger');
            setTimeout(() => redirectTo('index.html'), 1500);
        }

        let allOrders = [];
        let allBooks = [];

        // Load statistics
        async function loadStatistics() {
            try {
                // Load books count
                const booksResponse = await apiGet(ENDPOINTS.BOOKS);
                const books = booksResponse.books || [];
                document.getElementById('totalBooks').textContent = books.length;
                
                // Load orders
                const ordersResponse = await apiGet(ENDPOINTS.ADMIN_ORDERS, true);
                const orders = ordersResponse.data || [];
                document.getElementById('totalOrders').textContent = orders.length;
                
                // Load users count (only customers, role=0)
                const usersResponse = await apiGet(ENDPOINTS.USERS, true);
                const users = usersResponse.users || [];
                const customers = users.filter(user => user.role === 0);
                document.getElementById('totalUsers').textContent = customers.length;
                
                // Calculate revenue (only delivered orders)
                const deliveredOrders = orders.filter(order => order.order_status === 'Delivered');
                const revenue = deliveredOrders.reduce((sum, order) => sum + (parseFloat(order.total_amount) || 0), 0);
                document.getElementById('totalRevenue').textContent = formatCurrency(revenue);
                
            } catch (error) {
                console.error('Error loading statistics:', error);
            }
        }

        // Load orders
        async function loadOrders() {
            const container = document.getElementById('ordersContainer');
            
            try {
                const response = await apiGet(ENDPOINTS.ADMIN_ORDERS, true);
                allOrders = response.data || [];
                
                if (allOrders.length === 0) {
                    container.innerHTML = '<p class="text-center text-muted">No orders found</p>';
                    return;
                }
                
                container.innerHTML = `
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Order ID</th>
                                    <th>Customer</th>
                                    <th>Date</th>
                                    <th>Total</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${allOrders.map(order => `
                                    <tr>
                                        <td>#${order.id.substring(0, 8)}</td>
                                        <td>${order.user_name || 'N/A'}</td>
                                        <td>${formatDate(order.order_date || order.created_at)}</td>
                                        <td>${formatCurrency(order.total_amount)}</td>
                                        <td>
                                            <span class="badge bg-${getStatusColor(order.order_status)}">
                                                ${order.order_status}
                                            </span>
                                        </td>
                                        <td>
                                            <button class="btn btn-sm btn-primary" onclick="showOrderStatusModal('${order.id}', '${order.order_status}')">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            } catch (error) {
                container.innerHTML = '<div class="alert alert-danger">Error loading orders</div>';
                console.error('Error loading orders:', error);
            }
        }

        // Load books
        async function loadBooks() {
            const container = document.getElementById('booksContainer');
            
            try {
                const response = await apiGet(ENDPOINTS.BOOKS);
                allBooks = response.books || [];
                
                if (allBooks.length === 0) {
                    container.innerHTML = '<p class="text-center text-muted">No books found</p>';
                    return;
                }
                
                container.innerHTML = `
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Image</th>
                                    <th>Title</th>
                                    <th>Author</th>
                                    <th>Category</th>
                                    <th>Price</th>
                                    <th>Stock</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${allBooks.map(book => `
                                    <tr>
                                        <td>
                                            <img src="${book.image_url || 'assets/images/placeholder-book.svg'}" 
                                                 style="width: 40px; height: 60px; object-fit: cover;">
                                        </td>
                                        <td>${book.title}</td>
                                        <td>${book.author?.name || 'N/A'}</td>
                                        <td>${book.category?.name || 'N/A'}</td>
                                        <td>${formatCurrency(book.price)}</td>
                                        <td>
                                            <span class="badge ${book.stock_quantity > 0 ? 'bg-success' : 'bg-danger'}">
                                                ${book.stock_quantity}
                                            </span>
                                        </td>
                                        <td>
                                            <button class="btn btn-sm btn-warning" onclick="editBook('${book.id}')">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button class="btn btn-sm btn-danger" onclick="deleteBook('${book.id}')">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            } catch (error) {
                container.innerHTML = '<div class="alert alert-danger">Error loading books</div>';
                console.error('Error loading books:', error);
            }
        }

        // Get status color
        function getStatusColor(status) {
            const colors = {
                'Pending': 'warning',
                'Confirmed': 'info',
                'Processing': 'info',
                'Shipped': 'primary',
                'Delivered': 'success',
                'Cancelled': 'danger'
            };
            return colors[status] || 'secondary';
        }

        // Show order status modal
        function showOrderStatusModal(orderId, currentStatus) {
            document.getElementById('currentOrderId').value = orderId;
            document.getElementById('orderStatus').value = currentStatus;
            new bootstrap.Modal(document.getElementById('orderStatusModal')).show();
        }

        // Update order status
        async function updateOrderStatus() {
            const orderId = document.getElementById('currentOrderId').value;
            const newStatus = document.getElementById('orderStatus').value;
            
            try {
                const endpoint = ENDPOINTS.ADMIN_ORDER_STATUS(orderId);
                await apiPut(endpoint, { status: newStatus }, true);
                showToast('Order status updated successfully', 'success');
                bootstrap.Modal.getInstance(document.getElementById('orderStatusModal')).hide();
                await loadOrders();
                await loadStatistics();
            } catch (error) {
                showToast(error.message || 'Failed to update order status', 'danger');
            }
        }

        // Book management functions
        async function showAddBookModal() {
            // Load authors and categories for dropdowns
            try {
                const [authorsResponse, categoriesResponse] = await Promise.all([
                    apiGet(ENDPOINTS.AUTHORS),
                    apiGet(ENDPOINTS.CATEGORIES)
                ]);
                
                const authors = authorsResponse.data || [];
                const categories = categoriesResponse.data || [];
                
                // Populate authors dropdown
                const authorSelect = document.getElementById('bookAuthor');
                authorSelect.innerHTML = '<option value="">Select Author</option>' +
                    authors.map(a => `<option value="${a.id}">${a.author_name}</option>`).join('');
                
                // Populate categories dropdown
                const categorySelect = document.getElementById('bookCategory');
                categorySelect.innerHTML = '<option value="">Select Category</option>' +
                    categories.map(c => `<option value="${c.id}">${c.category_type}</option>`).join('');
                
                // Reset form
                document.getElementById('addBookForm').reset();
                
                // Reset modal for adding (not editing)
                document.querySelector('#addBookModal .modal-title').textContent = 'Add New Book';
                const saveBtn = document.querySelector('#addBookModal .btn-primary');
                saveBtn.textContent = 'Add Book';
                saveBtn.onclick = addBook;
                
                // Show modal
                new bootstrap.Modal(document.getElementById('addBookModal')).show();
            } catch (error) {
                showToast('Failed to load form data', 'danger');
                console.error(error);
            }
        }

        async function addBook() {
            const bookData = {
                title: document.getElementById('bookTitle').value.trim(),
                isbn: document.getElementById('bookIsbn').value.trim() || null,
                price: parseFloat(document.getElementById('bookPrice').value),
                stock_quantity: parseInt(document.getElementById('bookStock').value),
                author_id: document.getElementById('bookAuthor').value || null,
                category_id: document.getElementById('bookCategory').value || null,
                image_url: document.getElementById('bookImageUrl').value.trim() || null,
                description: document.getElementById('bookDescription').value.trim() || null
            };

            // Validate required fields
            if (!bookData.title) {
                showToast('Title is required', 'danger');
                return;
            }
            if (!bookData.price || bookData.price <= 0) {
                showToast('Valid price is required', 'danger');
                return;
            }

            try {
                await apiPost(ENDPOINTS.BOOKS, bookData, true);
                showToast('Book added successfully', 'success');
                bootstrap.Modal.getInstance(document.getElementById('addBookModal')).hide();
                await loadBooks();
                await loadStatistics();
            } catch (error) {
                showToast(error.message || 'Failed to add book', 'danger');
            }
        }

        async function editBook(bookId) {
            const book = allBooks.find(b => b.id === bookId);
            if (!book) {
                showToast('Book not found', 'danger');
                return;
            }
            
            // Populate form with book data
            document.getElementById('bookTitle').value = book.title || '';
            document.getElementById('bookIsbn').value = book.isbn || '';
            document.getElementById('bookPrice').value = book.price || 0;
            document.getElementById('bookStock').value = book.stock_quantity || 0;
            document.getElementById('bookImageUrl').value = book.image_url || '';
            document.getElementById('bookDescription').value = book.description || '';
            
            // Load authors and categories for dropdowns
            try {
                const [authorsResponse, categoriesResponse] = await Promise.all([
                    apiGet(ENDPOINTS.AUTHORS),
                    apiGet(ENDPOINTS.CATEGORIES)
                ]);
                
                const authors = authorsResponse.data || [];
                const categories = categoriesResponse.data || [];
                
                // Populate authors dropdown
                const authorSelect = document.getElementById('bookAuthor');
                authorSelect.innerHTML = '<option value="">Select Author</option>' +
                    authors.map(a => `<option value="${a.id}" ${book.author_id === a.id ? 'selected' : ''}>${a.author_name}</option>`).join('');
                
                // Populate categories dropdown
                const categorySelect = document.getElementById('bookCategory');
                categorySelect.innerHTML = '<option value="">Select Category</option>' +
                    categories.map(c => `<option value="${c.id}" ${book.category_id === c.id ? 'selected' : ''}>${c.category_type}</option>`).join('');
                
                // Change modal title and button
                document.querySelector('#addBookModal .modal-title').textContent = 'Edit Book';
                const saveBtn = document.querySelector('#addBookModal .btn-primary');
                saveBtn.textContent = 'Update Book';
                saveBtn.onclick = () => updateBook(bookId);
                
                // Show modal
                new bootstrap.Modal(document.getElementById('addBookModal')).show();
            } catch (error) {
                showToast('Failed to load form data', 'danger');
                console.error(error);
            }
        }

        async function deleteBook(bookId) {
            if (!confirm('Are you sure you want to delete this book?')) return;
            
            try {
                await apiDelete(`${ENDPOINTS.BOOKS}/${bookId}`, true);
                showToast('Book deleted successfully', 'success');
                await loadBooks();
                await loadStatistics();
            } catch (error) {
                showToast(error.message || 'Failed to delete book', 'danger');
            }
        }
        async function updateBook(bookId) {
            const bookData = {
                title: document.getElementById('bookTitle').value.trim(),
                isbn: document.getElementById('bookIsbn').value.trim() || null,
                price: parseFloat(document.getElementById('bookPrice').value),
                stock_quantity: parseInt(document.getElementById('bookStock').value),
                author_id: document.getElementById('bookAuthor').value || null,
                category_id: document.getElementById('bookCategory').value || null,
                image_url: document.getElementById('bookImageUrl').value.trim() || null,
                description: document.getElementById('bookDescription').value.trim() || null
            };

            if (!bookData.title || bookData.price <= 0) {
                showToast('Please fill in all required fields', 'warning');
                return;
            }

            try {
                await apiPut(`${ENDPOINTS.BOOKS}/${bookId}`, bookData, true);
                showToast('Book updated successfully', 'success');
                bootstrap.Modal.getInstance(document.getElementById('addBookModal')).hide();
                await loadBooks();
                await loadStatistics();
            } catch (error) {
                showToast(error.message || 'Failed to update book', 'danger');
            }
        }
        // ===== AUTHORS MANAGEMENT =====
        let allAuthors = [];

        async function loadAuthors() {
            try {
                const response = await apiGet(ENDPOINTS.AUTHORS);
                allAuthors = response.data || [];
                
                const container = document.getElementById('authorsContainer');
                if (allAuthors.length === 0) {
                    container.innerHTML = '<p class="text-center text-muted">No authors found</p>';
                    return;
                }
                
                displayAuthors(allAuthors);
            } catch (error) {
                document.getElementById('authorsContainer').innerHTML = 
                    '<p class="text-center text-danger">Failed to load authors</p>';
                console.error(error);
            }
        }

        function displayAuthors(authors) {
            const container = document.getElementById('authorsContainer');
            
            if (authors.length === 0) {
                container.innerHTML = '<p class="text-center text-muted">No authors found</p>';
                return;
            }
            
            let html = `
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th style="width: 80px;">#</th>
                                <th>Author Name</th>
                                <th style="width: 100px;">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            authors.forEach((author, index) => {
                html += `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${author.author_name}</td>
                        <td>
                            <button class="btn btn-sm btn-danger" onclick="deleteAuthor('${author.author_name}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            html += '</tbody></table></div>';
            container.innerHTML = html;
        }

        function filterAuthors() {
            const searchTerm = document.getElementById('authorSearch').value.toLowerCase();
            const filteredAuthors = allAuthors.filter(author => 
                author.author_name.toLowerCase().includes(searchTerm)
            );
            displayAuthors(filteredAuthors);
        }

        function showAddAuthorModal() {
            document.getElementById('addAuthorForm').reset();
            new bootstrap.Modal(document.getElementById('addAuthorModal')).show();
        }

        async function addAuthor() {
            const authorName = document.getElementById('authorName').value.trim();
            
            if (!authorName) {
                showToast('Please enter author name', 'warning');
                return;
            }
            
            try {
                const response = await apiPost(ENDPOINTS.AUTHORS, { author_name: authorName }, true);
                showToast('Author added successfully', 'success');
                bootstrap.Modal.getInstance(document.getElementById('addAuthorModal')).hide();
                await loadAuthors();
            } catch (error) {
                showToast(error.message || 'Failed to add author', 'danger');
            }
        }

        async function deleteAuthor(authorName) {
            if (!confirm('Are you sure you want to delete this author?')) return;
            
            try {
                await apiDelete(`${ENDPOINTS.AUTHORS}/name/${encodeURIComponent(authorName)}`, true);
                showToast('Author deleted successfully', 'success');
                await loadAuthors();
            } catch (error) {
                showToast(error.message || 'Failed to delete author', 'danger');
            }
        }

        // ===== ANALYTICS & CHARTS =====
        let charts = {};

        async function loadCharts() {
            try {
                // Load orders for charts
                const ordersResponse = await apiGet(ENDPOINTS.ADMIN_ORDERS, true);
                const orders = ordersResponse.data || [];
                
                // Load books for charts
                const booksResponse = await apiGet(ENDPOINTS.BOOKS);
                const books = booksResponse.books || [];
                
                // Create Order Status Distribution Chart
                createOrderStatusChart(orders);
                
                // Create Revenue by Status Chart
                createRevenueChart(orders);
                
                // Create Books by Category Chart
                createCategoryChart(books);
                
                // Create Top Selling Books Chart (mock data as we don't have sales data)
                createTopBooksChart(books);
            } catch (error) {
                console.error('Failed to load charts:', error);
            }
        }

        function createOrderStatusChart(orders) {
            const statusCounts = {};
            orders.forEach(order => {
                const status = order.order_status || 'Unknown';
                statusCounts[status] = (statusCounts[status] || 0) + 1;
            });
            
            const ctx = document.getElementById('orderStatusChart');
            if (charts.orderStatus) charts.orderStatus.destroy();
            
            charts.orderStatus = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(statusCounts),
                    datasets: [{
                        data: Object.values(statusCounts),
                        backgroundColor: [
                            '#FFC107', // Pending
                            '#2196F3', // Confirmed
                            '#FF9800', // Shipped
                            '#4CAF50', // Delivered
                            '#F44336'  // Cancelled
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        function createRevenueChart(orders) {
            const revenueByStatus = {};
            orders.forEach(order => {
                const status = order.order_status || 'Unknown';
                const total = parseFloat(order.total_price) || 0;
                revenueByStatus[status] = (revenueByStatus[status] || 0) + total;
            });
            
            const ctx = document.getElementById('revenueChart');
            if (charts.revenue) charts.revenue.destroy();
            
            charts.revenue = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(revenueByStatus),
                    datasets: [{
                        label: 'Revenue (PKR)',
                        data: Object.values(revenueByStatus),
                        backgroundColor: '#2196F3'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return 'Rs. ' + value.toLocaleString();
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }

        function createCategoryChart(books) {
            // Count books by category
            const categoryCounts = {};
            books.forEach(book => {
                if (book.category && book.category.category_type) {
                    const cat = book.category.category_type;
                    categoryCounts[cat] = (categoryCounts[cat] || 0) + 1;
                }
            });
            
            // Get top 10 categories
            const sorted = Object.entries(categoryCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);
            
            const ctx = document.getElementById('categoryChart');
            if (charts.category) charts.category.destroy();
            
            charts.category = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sorted.map(([cat]) => cat),
                    datasets: [{
                        label: 'Number of Books',
                        data: sorted.map(([, count]) => count),
                        backgroundColor: '#4CAF50'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    indexAxis: 'y',
                    scales: {
                        x: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }

        function createTopBooksChart(books) {
            // Sort books by stock_quantity (as proxy for popularity) and take top 5
            const topBooks = books
                .filter(book => book.stock_quantity > 0)
                .sort((a, b) => b.price - a.price)
                .slice(0, 5);
            
            const ctx = document.getElementById('topBooksChart');
            if (charts.topBooks) charts.topBooks.destroy();
            
            charts.topBooks = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: topBooks.map(book => book.title.length > 30 ? 
                        book.title.substring(0, 30) + '...' : book.title),
                    datasets: [{
                        label: 'Price (PKR)',
                        data: topBooks.map(book => book.price),
                        backgroundColor: '#FF9800'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    indexAxis: 'y',
                    scales: {
                        x: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return 'Rs. ' + value.toLocaleString();
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }

        // Update loadDashboard to include authors and charts
        async function loadDashboard() {
            await Promise.all([
                loadStatistics(),
                loadOrders(),
                loadBooks(),
                loadAuthors(),
                loadCharts()
            ]);
        }

        // Refresh dashboard
        function refreshDashboard() {
            loadDashboard();
        }

        // Initialize
        loadDashboard();
    </script>
</body>
</html>
